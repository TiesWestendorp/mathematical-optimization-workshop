# Cutting stock problem

![Lumber mill](lumber_mill.png "Generated by ChatGPT")

As operator of a lumber mill, you are tasked with cutting raw materials into smaller pieces along one axis, producing smaller pieces according to client orders. Each raw is 10 meters long, making it big enough to produce more than one of the required smaller final pieces (of sizes 140, 320, 360 and 450 centimeters). The raw can be cut up into these pieces in different ways, called _patterns_. For example, you could cut the raw of 10 meters into:

- one piece each of 140, 360 and 450 centimeters, leaving 50 centimeters of waste;
- two pieces of 320 centimeters, and one of 360 centimeters, leaving no waste;
- seven pieces of 140 centimeters, leaving 20 centimeters of waste, or;
- two pieces of 450 centimeters, leaving 100 centimeters of waste.

Each possible pattern is generated through the given method `patterns`. Each value it yields is a `dict` that maps raw lengths to how many of that raw occur in the pattern. E.g., the pattern "one piece each of 140, 360 and 450 centimeters" becomes:
```
{
  140: 1,
  320: 0,
  360: 1,
  450: 1
}
```

On a particularly busy day, you are given the following order to fulfill (as seen in [input.csv](input.csv)):

| Raw lengths  | 1000   |
|--------------|--------|

| Final length | Demand |
|--------------|--------|
| 140          | 211    |
| 320          | 395    |
| 360          | 610    |
| 450          | 97     |

## Exercises

In total, there are 13 different patterns by which we can cut up the raw material without leaving a piece of waste larger than the smallest possible final length (140 in our case). Let's say we will associate a variable with each of these patterns, indicating how many raws we cut according to this pattern. I.e.:

- $x_1$ indicates how many raws we cut into one piece of 140, 360, and 450 each
- $x_2$ indicates how many raws we cut into two pieces of 320, and one piece of 360
- $x_3$ indicates how many raws we cut into two pieces of 450
- $x_4$ indicates how many raws we cut into seven pieces of 140
- et cetera.

Such that at least producing the number of finals from the customer order with just these first four patterns can be formulated as:
$$
x_1 + 7x_4 \geq 211,\\
2x_2 \geq 395,\\
x_1 + x_2 \geq 610,\\
x_1 + 2x_3 \geq 97.
$$

Rewritten in standard form, these become:
$$
-x_1 - 7x_4 \leq -211,\\
-2x_2 \leq -395,\\
-x_1 - x_2 \leq -610,\\
-x_1 -2x_3 \leq -97.
$$

In other words, for each final length $f$, we add a linear constraint 

If we let $x_p$ represent the number of raws that are cut according to pattern $p$, and let $a_{f,p}$ represent the amount of finals $f$ produced by pattern $p$. We should at least produce the number of finals as specified in the customer order. How do the constraints look, as a function of $x_p$? Are there any other constraints?

 1. Minimize the number of raws that are required to be able to fulfill the order. How should the raws be cut? Write an [ILP program](https://en.wikipedia.org/wiki/Integer_programming) using [`scipy.optimize.linprog`](https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.linprog.html).

As it turns out, quite some waste is generated when minimizing the number of used raws. Hence, rather than minimizing the number of used raws, let's instead minimize the produced waste. How do we express the total waste as a function of $x_p$?

 2. Adapt your program to minimize the produced waste while still fulfilling the order. How should the raws be cut?

While minimizing waste, we favoured overproducing finals over creating waste: we often chose to produce according to patterns with zero waste - so we reduced waste, but at the cost of using more raws in order to overproduce. In reality, however, overproduced finals are also undesirable (though not as undesirable as waste), since they need to be stored until a new order comes in where they can be used. Introduce a new variable for each final, that represents how much overproduction occurs for each final.

 3. Let's consider overproduced finals to be as bad as half their length in waste, e.g. a single overproduced final of length 14 is as bad as a waste of 7. Alter your previous program to account for this.

**Bonus question**: Fulfilling demand while minimizing waste and overproduction seems much more reasonable, but there is a practical consideration we haven't accounted for: reconfiguring the saw to a different pattern also requires effort. There are multiple ways by which we might account for this. One way is to limit the number of different patterns that we use. We will introduce boolean variables $z_k$ that are $1$ when $x_k > 0$, and $0$ otherwise (they indicate whether pattern $k$ is "used"). To ensure this is the case, add the constraints: $x_k \leq M z_k$, where $M$ is a "very big constant". This constraint ensures that $x_k$ can not be non-zero while $z_k$ is zero.

 4. We must choose $M$ such that $x_k$ does not become limited by the constraint. Which value is appropriate?

 5. Alter your program by adding a constraint that limits the number of different patterns used to three. 

See also:
 - [Cutting stock problem](https://en.wikipedia.org/wiki/Cutting_stock_problem)
 - [Bin packing problem](https://en.wikipedia.org/wiki/Bin_packing_problem)
